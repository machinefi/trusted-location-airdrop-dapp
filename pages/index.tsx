import Head from 'next/head'
import { Home } from "../containers/Home";
import { airdrops } from '../airdrops';
import { Airdrop } from "../types/Airdrop";
import { useEffect, useState } from "react";
import { Text, Center } from '@chakra-ui/react'
import { useContractReads } from 'wagmi'
import { LogicContractAddress } from "../config/addresses"
import LogicContract from "../artifacts/contracts/Logic.sol/Logic.json"

interface HomePageprops {
  airdrops: Airdrop[]
}

export default function HomePage({ airdrops }: HomePageprops) { // run in client 

  const [drops, setDrops] = useState();

  const logicContract = {
    address: LogicContractAddress,
    abi: LogicContract.abi,
  }

  const { data: airdropHashes } = useContractReads({

    contracts: [
      {
        ...logicContract,
        functionName: "getAllHashes",
        chainId: 4690,
      }
    ]
  })

  const hashes: any = airdropHashes?.[0];

  let result: any = []

  hashes?.forEach((drop) => {
    const {data: Airdrop} = useContractReads({
      contracts: [
        {
          ...logicContract,
          functionName: "airDrops",
          chainId: 4690,
          args: [drop]
        }
      ]
    })
    result.push(Airdrop?.[0])
  });

  const allDrops = result?.map((drop) => {
    const data = {
      lat: drop?.[0].toString(),
      long: drop?.[1].toString(), 
      max_distance: drop?.[2].toString(),
      time_from: drop?.[3].toString(),
      time_to: drop?.[4].toString(),
      tokens_count: drop?.[5].toString(),
      tokens_minted: drop?.[6].toString()
    }
    return data
  })

  useEffect(() => {
    console.log("hashes", hashes)
    console.log("result", allDrops)
    setDrops(allDrops)
  }, [])

  return (
    <div >
      <Head>
        <title>Geostream Airdrop App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main>
        <Center>
          <Text
            fontSize='4xl'
            bgGradient='linear(to-l, #7928CA, #FF0080)'
            bgClip='text'
            as='b'
          >
            NFT GeoStream Airdrop</Text>
        </Center>
        <Center>
          <Text
            fontSize='xl'
            as='i'
          >check out all the available airdrops</Text>
        </Center>

        <div>
          <Home airdrops={drops} />
        </div>
      </main>
    </div>
  )
}

export function getStaticProps() { // run server side 
  return {
    props: {
      airdrops
    }
  }
}
